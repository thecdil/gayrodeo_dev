<script type="text/javascript">
  let url = new URL(window.location);
     let params = url.searchParams;
 
     function vizFilter(x) {
  var rects = document.getElementsByTagName('rect');
  params.set('filter', x);
    var p = params.toString();
    window.history.replaceState({}, '', location.pathname + '?' + p);
  for (i = 0; i < rects.length; i++) {
    var classString = rects[i].classList;
        classString.add('dark');
        classString.forEach(item=>{
    if(item.startsWith('primary')) {
      classString.remove(item) ;}});
    if (x == "all"){
      classString.remove('dark');
      resetVals();
    } else if (classString.contains(x)){
      classString.remove('dark');          
      classString.add("primary-" + x);  
    } else if (x == "darkforall"){ }
        }
    }


     function searchLines(x) {
     var itemcontainer = document.getElementById("contents-container");
     var lines = itemcontainer.getElementsByClassName("line");
     var input, filter, p, span, i;
     input = x;
     let params = url.searchParams;
     params.set('q', input);
     params.delete('filter');
     params.delete('line');
     var p = params.toString();
     window.history.replaceState({}, '', location.pathname + '?' + p);
     var filter = input.toUpperCase();
     var searchResults = '<option>Select and scroll to a matching line</option>';
     for (i = 0; i < lines.length; i++) {
       itemcontents = lines[i].getElementsByClassName("words")[0];
       var index = itemcontents.innerHTML.indexOf(input);
       if (itemcontents) {
         itemcontents.classList.add("text-muted");
         itemcontents.classList.remove("featured");
         if (itemcontents.innerHTML.toUpperCase().indexOf(filter) > -1) {
           itemcontents.classList.add("featured");
           itemcontents.classList.remove("text-muted");
           searchResults += '<option class=text-truncate" style="max-width: 250px;" value="{{page.object-id}}'+ i +'">Line ' + i + ' -- ' + itemcontents.innerHTML.substring(0,125) + '...</option>';
           itemcontents.innerHTML = itemcontents.innerHTML.replace(input, "<span class='text-danger'>" + input + "</span>");
           var rightnum = i + 1;
           var rectal = "rect" + rightnum;
           console.log(rectal);
           document.getElementById(rectal).classList.add("hilite");
           vizFilter('hilite');
           } else { 
         }
       }
      document.getElementById("filters").selectedIndex = 0;
      let numberofint = document.querySelectorAll('.featured').length;
      document.getElementById("numberof").innerHTML = numberofint + " lines match your query";
      document.getElementById("searchResults").innerHTML = searchResults;
      document.getElementById("linecount").classList.remove("d-none");
      document.getElementById("filtersearch").classList.remove("d-none");
     }
   }
 
   function filterLines() {
     var itemcontainer = document.getElementById("contents-container");
     var lines = itemcontainer.getElementsByClassName("line");
     var filterClass = document.getElementById("filters").value;
     var item = itemcontainer.getElementsByClassName(filterClass);  
     vizFilter(filterClass);
     params.set('filter', filterClass);
     params.delete('q');
     params.delete('line');

     var p = params.toString();
     window.history.replaceState({}, '', location.pathname + '?' + p);
     var searchResults = '<option>Select and scroll to a matching line</option>';
     for (i = 0; i < lines.length; i++) {
       lines[i].classList.remove('featured');
       itemcontents = lines[i].getElementsByClassName("words")[0];
       if (itemcontents) {
         itemcontents.classList.remove("featured");
         if (lines[i].classList.contains(filterClass)) {
       itemcontents.classList.add("featured");
       itemcontents.classList.remove("small","text-muted");
       var prevLine = i - 1;
       var nextLine = i + 1;
         if (!lines[prevLine].classList.contains(filterClass)){
         searchResults += '<option class="text-truncate" style="max-width: 250px;" value="{{page.object-id}}'+ i +'">Line ' + i ;
           var startLine = itemcontents.innerHTML.substring(0,125);
           var startNumber = i;
         }
         else if (lines[nextLine].classList.contains(filterClass) && lines[prevLine].classList.contains(filterClass) ){
           searchResults += '';
         } 
         else if (!lines[nextLine].classList.contains(filterClass)){
           var lineTotal = i - startNumber + 1;
           searchResults +=  ' to Line ' + i + ' (' + lineTotal +  ' lines total) -- ' + startLine + '...</option>';
         } 
       }
       else {
         itemcontents.classList.add("small","text-muted");     }
       }
     }
      document.getElementById("quicksearch").value = "";
      document.getElementById("searchResults").innerHTML = searchResults;
      document.getElementById("linecount").classList.remove("d-none");
      document.getElementById("filtersearch").classList.remove("d-none");
      countforFilter(filterClass);
     }
   
     function countforFilter(x){
     var numberofint = document.querySelectorAll('.' + x).length;
     var sectnumber = document.getElementsByClassName('text-truncate').length;
     if (sectnumber == 1){
       var sectnumber = sectnumber + " section "
     } else {
       var sectnumber = sectnumber + " sections "
     }
     document.getElementById("numberof").innerHTML = sectnumber + "(" +  numberofint + " lines) are tagged as related to " + x;
   }
 
 
 var elem = document.getElementById("quicksearch");
 elem.onkeyup = function(e){
     if(e.keyCode == 13){
       var searchval = document.getElementById('quicksearch').value; 
       searchLines(searchval);
     }
 }
 
   function scrollToLine(x) {
      var targetElement = document.getElementById(x);
      if (targetElement) {
        // Smoothly scroll to the element
        targetElement.scrollIntoView({
          behavior: 'smooth',  // Enables smooth scrolling
          block: 'start'       // Aligns to the top of the viewport
        });
      }
    }

 
 
 
 function resetVals(){
     params.delete('q');
      params.delete('filter');
      params.delete('line');
      window.history.replaceState({}, '', location.pathname);
   document.getElementById("linecount").classList.add("d-none");
      document.getElementById("filtersearch").classList.add("d-none");
      document.getElementById("quicksearch").value = "";
      document.getElementById("filters").selectedIndex = 0;
      var words = document.querySelectorAll("p.words")
      for (i = 0; i < words.length; i++) {
       words[i].classList.remove('text-muted');
       words[i].classList.remove('featured');
       words[i].classList.remove('small');
       if ( words[i].querySelector(".text-danger")){
       words[i].getElementsByClassName('text-danger')[0].classList.remove('text-danger');}
      }
      var svgContainer  = document.getElementById("colorViz");
      var rects = svgContainer.getElementsByTagName('rect');
      for (i = 0; i < rects.length; i++) {
       rects[i].classList.remove('dark');
       rects[i].classList.remove('hilite');
       rects[i].classList.remove('primary-hilite');

 
      }
 }
 
  function vizFilter(x) {
   var svgContainer  = document.getElementById("colorViz");
   var rects = svgContainer.getElementsByTagName('rect');
   for (i = 0; i < rects.length; i++) {
     var classString = rects[i].classList;
         classString.add('dark');
         classString.forEach(item=>{
     if(item.startsWith('primary')) {
       classString.remove(item) ;}});
     if (x == "all"){
       classString.remove('dark');
       resetVals();
     } else if (classString.contains(x)){
       classString.remove('dark');          
       classString.add("primary-" + x);  
     } else if (x == "darkforall"){ }
         }
     }
 
 
    
 
 
 
 

  (function(){
      

  var dataFilter = url.searchParams.get('q');
  var codeFilter = url.searchParams.get('filter');
  var lineFilter = url.searchParams.get('line');

  var hashfilter = decodeURIComponent(location.hash.substr(1));//.replace(/%20/g, " ");
   if(dataFilter) { 
       // code to be executed if a hash is contained in the url
  document.getElementById('quicksearch').value = dataFilter;
  document.getElementById('goButton').click();
  params.delete('filter'); 
  document.getElementById('quicksearch').scrollIntoView();
  
   //$(hashfilterclass).addClass('active');
   }
  else if (codeFilter) { 
      // code to be executed if a filter is contained in the url search parameters
  document.getElementById('filters').value = codeFilter;
  filterLines();
  vizFilter(codeFilter);
  document.getElementById('colorViz').scrollIntoView();
  params.delete('q');
   }
   else if(hashfilter) { 
       // code to be executed if an anchor (#) is contained in the url
       document.getElementById(hashfilter).classList.add('featured');
       params.delete('q'); params.delete('filter'); 
       
       
   }
   else if(lineFilter){    
       params.delete('q'); 
       params.delete('filter'); 
       var targetElement = document.getElementById(lineFilter);
            if (targetElement) {
              targetElement.classList.add('featured');
                // Smoothly scroll to the element
                targetElement.scrollIntoView({
                    behavior: 'smooth',  // Enables smooth scrolling
                    block: 'start'       // Aligns to the top of the viewport
                });
            }
   }
   else{

   };
  })();

 
  </script>
 